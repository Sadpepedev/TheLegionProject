<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>The Legion Project</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
  <style>
    body {
      background-color: #000000;
      color: #FFFFFF;
      font-family: sans-serif;
    }
    .active-tab {
      border-bottom: 2px solid #FF0000;
      font-weight: bold;
    }
    .status-live {
      background-color: #4CAF50; /* Green */
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
    }
    .status-soon {
      background-color: #FF9800; /* Orange */
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
    }
    .status-ico {
      background-color: #3F51B5; /* Blue */
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 12px;
    }
    .disabled-button {
      background-color: #4A5568; /* Gray */
      cursor: not-allowed;
    }
    #results {
      display: none;
    }
  </style>
</head>

<body class="font-sans">
  <!-- Top Bar Navigation -->
  <nav class="bg-gray-900 text-white shadow-md">
    <div class="container mx-auto flex flex-col lg:flex-row items-center justify-between py-4 px-6">
      <!-- Hamburger Menu for Mobile -->
      <div class="block lg:hidden mr-4">
        <button id="mobileMenuToggle" class="text-white focus:outline-none">
          <svg 
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6" 
            fill="none"
            viewBox="0 0 24 24" 
            stroke="currentColor"
          >
            <path 
              stroke-linecap="round" 
              stroke-linejoin="round" 
              stroke-width="2" 
              d="M4 6h16M4 12h16M4 18h16" 
            />
          </svg>
        </button>
      </div>

      <!-- Navigation Tabs -->
      <div id="navTabs" class="hidden lg:flex lg:space-x-6 lg:flex-row lg:items-center flex-col">
        <button class="sale-tab" onclick="switchSale('overview')">Overview</button>
        <button class="sale-tab" onclick="switchSale('fuel')">
          Fuel <span class="status-live">Live</span>
        </button>
        <button class="sale-tab" onclick="switchSale('almanak')">
          Almanak <span class="status-soon">Trading Soon</span>
        </button>
        <button class="sale-tab" onclick="switchSale('pulse')">
          Pulse <span class="status-soon">Trading Soon</span>
        </button>
        <button class="sale-tab" onclick="switchSale('silencio')">
          Silencio <span class="status-soon">Trading Soon</span>
        </button>
        <button class="sale-tab" onclick="switchSale('enclave')">
          Enclave <span class="status-ico">ICO Soon</span>
        </button>
        <button class="sale-tab" onclick="switchSale('corn')">
          Corn <span class="status-ico">ICO Soon</span>
        </button>
      </div>

      <!-- Connect Wallet -->
      <div class="mt-4 lg:mt-0">
        <button
          class="bg-gray-700 hover:bg-gray-600 text-white py-2 px-4 rounded disabled-button cursor-pointer"
          onclick="alert('Coming Soon!')"
        >
          Connect Wallet
        </button>
      </div>
    </div>
  </nav>

  <!-- Overview Section -->
  <div
    id="overviewSection"
    class="container mx-auto mt-12 px-6 py-8 bg-gray-900 rounded-lg shadow-lg max-w-2xl"
    style="display: none;"
  >
    <h2 class="text-3xl font-extrabold text-center mb-6">Token Overview</h2>
    <p class="text-sm text-center text-gray-400 mb-8">
      Below are all tokens and their ROI from ICO price (in %):
    </p>
    <div id="overviewList" class="space-y-4"></div>
  </div>

  <!-- Main Sale Container -->
  <div 
    id="mainSaleContainer"
    class="container mx-auto mt-12 px-6 py-8 bg-gray-900 rounded-lg shadow-lg max-w-2xl"
  >
    <h1 id="saleTitle" class="text-3xl font-extrabold text-center mb-6">Fuel</h1>
    <p class="text-sm text-center text-gray-400 mb-8">
      Enter your initial ICO investment to calculate your current ROI for 
      <span id="tokenName">Fuel Token</span>
    </p>
    <form onsubmit="calculateROI(event)">
      <div class="mb-6">
        <label 
          for="investment"
          class="block text-gray-200 text-center font-semibold"
        >
          Initial Investment ($):
        </label>
        <input 
          type="number"
          id="investment"
          class="w-full p-3 bg-gray-800 rounded text-center text-gray-200"
          placeholder="Enter your investment"
        >
      </div>
      <p class="text-sm text-center mb-6">
        <strong>Seed Round Price:</strong> <span id="seedPrice">$0.02</span>
      </p>
      <button 
        id="calculateButton"
        type="submit"
        class="w-full py-3 rounded font-bold text-white shadow-md"
      >
        Calculate
      </button>
    </form>
    <div id="results" class="mt-8 p-6 bg-gray-800 rounded text-center"></div>
  </div>

  <!-- Footers -->
  <footer class="mt-10 text-center text-gray-500">
    Built by 
    <a href="https://x.com/Dustybeerbong" target="_blank" class="text-blue-400 hover:underline">
      Sadpepe.exe
    </a>
  </footer>
  <footer class="bg-gray-800 text-gray-400 text-sm text-center py-4 mt-8">
    <p>
      Price data provided by 
      <a href="https://coingecko.com" target="_blank" class="text-blue-400 hover:underline">
        CoinGecko
      </a>.
    </p>
  </footer>

  <script>
    const mobileMenuToggle = document.getElementById("mobileMenuToggle");
    const navTabs = document.getElementById("navTabs");
    mobileMenuToggle.addEventListener("click", () => {
      navTabs.classList.toggle("hidden");
    });

    // Tokens
    const sales = {
      fuel: {
        title: "Fuel",
        tokenName: "Fuel Token",
        seedPrice: 0.02,
        isTradable: true,
        fontColor: "#32CD32",
        buttonColor: "#32CD32",
      },
      almanak: {
        title: "Almanak",
        tokenName: "Almanak Token",
        seedPrice: 0.0435,
        isTradable: false,
        fontColor: "#FFFFFF",
        buttonColor: "#4A5568",
      },
      pulse: {
        title: "Pulse",
        tokenName: "Pulse Token",
        seedPrice: "Coming Soon",
        isTradable: false,
        fontColor: "#0000FF",
        buttonColor: "#1E90FF",
      },
      silencio: {
        title: "Silencio",
        tokenName: "Silencio Token",
        seedPrice: "Coming Soon",
        isTradable: false,
        fontColor: "#87CEEB",
        buttonColor: "#4682B4",
      },
      enclave: {
        title: "Enclave",
        tokenName: "Enclave Token",
        seedPrice: "ICO Soon",
        isTradable: false,
        fontColor: "#FFFFFF",
        buttonColor: "#ADD8E6",
      },
      corn: {
        title: "Corn",
        tokenName: "Corn Token",
        seedPrice: "ICO Soon",
        isTradable: false,
        fontColor: "#FFA500",
        buttonColor: "#FF8C00",
      }
    };

    // Default page => overview
    let currentSale = 'overview';

    // optional caching
    let cachedFuelData = null;
    let cachedFuelTimestamp = null;
    const CACHE_TTL = 60000; // 60 seconds

    function switchSale(sale) {
      currentSale = sale;

      if (sale === 'overview') {
        document.querySelectorAll(".sale-tab").forEach((tab) => tab.classList.remove("active-tab"));
        document.querySelector(`[onclick="switchSale('overview')"]`).classList.add("active-tab");
        document.getElementById("mainSaleContainer").style.display = "none";
        document.getElementById("overviewSection").style.display = "block";
        showOverview();
        return;
      } else {
        document.getElementById("overviewSection").style.display = "none";
        document.getElementById("mainSaleContainer").style.display = "block";
      }

      const saleData = sales[sale];
      if (!saleData) return;

      document.querySelectorAll(".sale-tab").forEach((tab) => tab.classList.remove("active-tab"));
      document.querySelector(`[onclick="switchSale('${sale}')"]`).classList.add("active-tab");

      document.getElementById("saleTitle").textContent = saleData.title;
      document.getElementById("tokenName").textContent = saleData.tokenName;

      if (typeof saleData.seedPrice === "string") {
        document.getElementById("seedPrice").textContent = saleData.seedPrice;
      } else {
        document.getElementById("seedPrice").textContent = `$${saleData.seedPrice.toFixed(4)}`;
      }

      const calculateButton = document.getElementById("calculateButton");
      if (!saleData.isTradable) {
        calculateButton.disabled = true;
        calculateButton.classList.add("disabled-button");
        calculateButton.classList.remove("bg-red-600");
      } else {
        calculateButton.disabled = false;
        calculateButton.classList.remove("disabled-button");
        calculateButton.classList.add("bg-red-600");
      }

      document.getElementById("saleTitle").style.color = saleData.fontColor;
      calculateButton.style.backgroundColor = saleData.buttonColor;

      document.getElementById("results").style.display = "none";
      document.getElementById("investment").value = "";
    }

    async function calculateROI(event) {
      event.preventDefault();
      const investment = parseFloat(document.getElementById("investment").value);
      const saleData = sales[currentSale];

      if (isNaN(investment) || investment <= 0) {
        alert("Please enter a valid investment amount.");
        return;
      }
      if (!saleData.isTradable) {
        document.getElementById("results").style.display = "block";
        document.getElementById("results").innerHTML = `
          <p class="text-lg text-gray-400">
            Current Token Price: <span class="text-white">Not Available</span>
          </p>
          <p class="text-lg text-gray-400">
            Current Value: <span class="text-white">Not Applicable</span>
          </p>
        `;
        return;
      }

      try {
        const response = await fetch("/calculate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ investment, round_price: saleData.seedPrice }),
        });
        const data = await response.json();
        if (data.error) {
          alert(data.error);
        } else {
          document.getElementById("results").style.display = "block";
          document.getElementById("results").innerHTML = `
            <p class="text-lg text-gray-400">
              Initial Investment: <span class="text-white">$${data.initial_investment.toFixed(2)}</span>
            </p>
            <p class="text-lg text-gray-400">
              Current Token Price: <span class="text-white">$${data.current_price.toFixed(4)}</span>
            </p>
            <p class="text-2xl font-bold mt-4" style="color:${saleData.fontColor}">
              Current Value: $${data.roi_value.toFixed(2)}
            </p>
          `;
        }
      } catch (error) {
        console.error("Error:", error);
        alert("An error occurred while calculating ROI.");
      }
    }

    // ====== The Key Fix: fetch Fuel FIRST, then append other tokens ======
    function showOverview() {
      const overviewList = document.getElementById("overviewList");
      overviewList.innerHTML = '';      

      // 1) Always fetch & append Fuel FIRST
      fetchFuelThen(() => {
        // 2) Then append the other tokens below
        const otherTokens = ['almanak', 'pulse', 'silencio', 'enclave', 'corn'];
        otherTokens.forEach((tokenKey) => {
          const tokenData = sales[tokenKey];
          if (!tokenData) return;
          addOverviewItem(tokenData.title, 'Coming Soon', 'text-blue-400');
        });
      });
    }

    // We fetch Fuel data (cached or new), then call a callback to append the rest
    function fetchFuelThen(onDone) {
      const fuelData = sales['fuel'];
      if (!fuelData.isTradable) {
        // If somehow not tradable, just show "Coming Soon"
        addOverviewItem('Fuel', 'Coming Soon', 'text-blue-400');
        if (typeof onDone === 'function') onDone();
        return;
      }

      // Check cache first
      if (cachedFuelData && cachedFuelTimestamp && Date.now() - cachedFuelTimestamp < CACHE_TTL) {
        console.log('Using cached Fuel data');
        displayFuelROI(cachedFuelData); 
        if (typeof onDone === 'function') onDone();
      } else {
        console.log('Fetching Fuel data');
        fetch("/calculate", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ investment: 100, round_price: fuelData.seedPrice }),
        })
        .then(res => res.json())
        .then((data) => {
          if (!data.error) {
            cachedFuelData = data;
            cachedFuelTimestamp = Date.now();
            displayFuelROI(data);
          } else {
            addOverviewItem('Fuel', 'Error', 'text-red-500');
          }
          if (typeof onDone === 'function') onDone();
        })
        .catch(() => {
          addOverviewItem('Fuel', 'Error', 'text-red-500');
          if (typeof onDone === 'function') onDone();
        });
      }
    }

    function displayFuelROI(data) {
      const fuelData = sales['fuel'];
      const pctGain = ((data.current_price - fuelData.seedPrice) / fuelData.seedPrice) * 100;
      let roiClass = 'text-green-400';
      if (pctGain < 0) roiClass = 'text-red-500';
      addOverviewItem('Fuel', `${pctGain.toFixed(2)}%`, roiClass);
    }

    function addOverviewItem(tokenName, roiText, colorClass) {
      const overviewList = document.getElementById("overviewList");
      const row = document.createElement('div');
      row.className = "flex justify-between items-center px-4 py-3 bg-gray-800 rounded";

      const nameEl = document.createElement('span');
      nameEl.className = "font-semibold";
      nameEl.textContent = tokenName;

      const roiEl = document.createElement('span');
      roiEl.className = colorClass;
      roiEl.textContent = roiText;

      row.appendChild(nameEl);
      row.appendChild(roiEl);
      overviewList.appendChild(row);
    }

    // Start on "overview"
    switchSale(currentSale);
  </script>
</body>
</html>
