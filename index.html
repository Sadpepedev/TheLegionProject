<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Track Legion ICO Performance</title>
  
  <!-- Tailwind CSS (Optimized via CDN for demonstration; consider using a build tool for production) -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.2.7/dist/tailwind.min.css" rel="stylesheet">

  <!-- Ethers.js v6 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.0.0/dist/ethers.min.js" defer></script>
  
  <!-- Google Fonts -->
  <link 
    href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" 
    rel="stylesheet"
  >
  
  <style>
    body {
      background: radial-gradient(ellipse at bottom, #1b2735 0%, #090a0f 100%);
      color: #FFFFFF;
      font-family: 'Orbitron', sans-serif; /* Futuristic vibe */
      min-height: 100vh;
    }

    /* Active Tab */
    .active-tab {
      border-b-2 border-teal-400 font-bold transition-all duration-200 ease-in-out;
    }

    /* Status Labels */
    .status-live {
      @apply bg-green-600 text-white px-2 py-1 rounded text-xs shadow-lg;
    }
    .status-soon {
      @apply bg-orange-500 text-white px-2 py-1 rounded text-xs shadow-lg;
    }
    .status-ico {
      @apply bg-blue-600 text-white px-2 py-1 rounded text-xs shadow-lg;
    }

    /* Disabled Button */
    .disabled-button {
      @apply bg-gray-600 cursor-not-allowed opacity-50;
    }

    /* Hide Results */
    #results {
      @apply hidden;
    }

    /* Navigation Tabs */
    .sale-tab {
      @apply transition-colors duration-200 ease-in-out;
    }
    .sale-tab:hover {
      @apply text-teal-400;
    }

    /* Neon Button */
    .neon-button {
      @apply border border-teal-400 relative transition-all duration-300 ease-in-out;
    }
    .neon-button:hover {
      @apply text-teal-400 shadow-[0_0_10px_#18FFF7,0_0_20px_#18FFF7];
    }

    /* Number Input Spin Buttons Removal */
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    /* Firefox */
    input[type=number] {
      -moz-appearance: textfield;
    }
  </style>

  <!-- Analytics Scripts (Ensure these paths are correct and secure) -->
  <script defer src="/_vercel/speed-insights/script.js"></script>
  <script defer src="/_vercel/insights/script.js"></script>
</head>

<body>
  <!-- Top Bar Navigation -->
  <nav class="shadow-md bg-black bg-opacity-75">
    <div class="container mx-auto flex flex-col lg:flex-row items-center justify-between py-4 px-6">
      <!-- Left Section: Tabs / Hamburger -->
      <div class="flex flex-col lg:flex-row items-center">
        <!-- Hamburger Menu for Mobile -->
        <div class="block lg:hidden mr-4">
          <button id="mobileMenuToggle" class="text-white focus:outline-none" aria-label="Toggle Navigation Menu">
            <svg 
              xmlns="http://www.w3.org/2000/svg" 
              class="h-6 w-6" 
              fill="none" 
              viewBox="0 0 24 24" 
              stroke="currentColor"
            >
              <path 
                stroke-linecap="round" 
                stroke-linejoin="round" 
                stroke-width="2" 
                d="M4 6h16M4 12h16M4 18h16" 
              />
            </svg>
          </button>
        </div>

        <!-- Navigation Tabs -->
        <div id="navTabs" class="hidden lg:flex lg:space-x-6 lg:flex-row lg:items-center flex-col">
          <!-- Overview first -->
          <button class="sale-tab" onclick="switchSale('overview')">Overview</button>

          <button class="sale-tab" onclick="switchSale('fuel')">
            Fuel <span class="status-live">Live</span>
          </button>
          <button class="sale-tab" onclick="switchSale('almanak')">
            Almanak <span class="status-soon">Trading Soon</span>
          </button>
          <button class="sale-tab" onclick="switchSale('pulse')">
            Pulse <span class="status-soon">Trading Soon</span>
          </button>
          <button class="sale-tab" onclick="switchSale('silencio')">
            Silencio <span class="status-soon">Trading Soon</span>
          </button>
          <button class="sale-tab" onclick="switchSale('enclave')">
            Enclave <span class="status-ico">ICO Soon</span>
          </button>
          <button class="sale-tab" onclick="switchSale('corn')">
            Corn <span class="status-ico">ICO Soon</span>
          </button>
        </div>
      </div>

      <!-- Right Section: Connect Wallet -->
      <div class="mt-4 lg:mt-0">
        <!-- "Connect Wallet"  -->
        <button
          id="connectWalletButton"
          class="neon-button py-2 px-4 text-white rounded focus:outline-none"
          onclick="connectWallet()"
        >
          Connect Wallet
        </button>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="container mx-auto mt-12 px-6">
    <!-- OVERVIEW SECTION -->
    <section
      id="overviewSection"
      class="hidden px-6 py-8 rounded-lg shadow-lg max-w-2xl mx-auto bg-black bg-opacity-65"
    >
      <h2 class="text-3xl font-extrabold text-center mb-6 text-teal-400">
        Token Overviews
      </h2>
      <p class="text-sm text-center text-gray-400 mb-8">
        Below are all Legion ICOs and their current ROI (in %):
      </p>

      <!-- List -->
      <div id="overviewList" class="space-y-4"></div>
    </section>

    <!-- SALE CONTAINER -->
    <section 
      id="mainSaleContainer"
      class="px-6 py-8 rounded-lg shadow-lg max-w-2xl mx-auto bg-black bg-opacity-65"
    >
      <h1 id="saleTitle" class="text-3xl font-extrabold text-center mb-6 text-teal-400">
        Fuel
      </h1>
      <p class="text-sm text-center text-gray-400 mb-8">
        Enter your initial approval amount or connect your wallet to calculate your current value for 
        <span id="tokenName">Fuel Token</span>
      </p>

      <!-- ROI Form -->
      <form id="roiForm" onsubmit="calculateROI(event)" class="space-y-6">
        <div>
          <label 
            for="investment" 
            class="block text-gray-200 text-center font-semibold mb-2"
          >
            Initial Investment ($):
          </label>
          <input 
            type="number" 
            id="investment" 
            name="investment"
            class="w-full p-3 bg-gray-800 rounded text-center text-gray-200 focus:outline-none focus:ring-2 focus:ring-indigo-500"
            placeholder="Enter your investment"
            required
            min="0.01"
            step="0.01"
            aria-required="true"
          >
        </div>
        <p class="text-sm text-center text-gray-400">
          <strong>Seed Round Price:</strong> <span id="seedPrice">$0.02</span>
        </p>

        <button 
          id="calculateButton" 
          type="submit" 
          class="w-full py-3 rounded font-bold text-white shadow-md bg-green-500 hover:bg-green-600 transition-colors duration-200"
        >
          Calculate
        </button>
      </form>

      <!-- Results Section -->
      <div id="results" class="mt-8 p-6 bg-gray-800 bg-opacity-80 rounded text-center"></div>
    </section>
  </main>

  <!-- Footers -->
  <footer class="mt-10 text-center text-gray-500">
    Built by 
    <a href="https://x.com/Dustybeerbong" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:underline">
      Sadpepe.exe
    </a>
  </footer>

  <footer class="text-gray-400 text-sm text-center py-4 mt-8 bg-black bg-opacity-75">
    <p>
      Price data provided by 
      <a href="https://coingecko.com" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:underline">
        CoinGecko
      </a>.
    </p>
    <br/>
  
    <p class="mx-4">
      <strong>Disclaimer:</strong> We are <em>not</em> affiliated with Legion and do 
      <em>not</em> offer financial or trading advice. This website is purely for informational 
      purposes to assist in tracking prior ICO performance. Always conduct your own 
      research before making any investment decisions.
    </p>
  </footer>

  <!-- Main JavaScript -->
  <script defer>
    document.addEventListener("DOMContentLoaded", () => {
      // Mobile Menu Toggle
      const mobileMenuToggle = document.getElementById("mobileMenuToggle");
      const navTabs = document.getElementById("navTabs");

      mobileMenuToggle.addEventListener("click", () => {
        navTabs.classList.toggle("hidden");
      });

      // All tokens
      const sales = {
        fuel: {
          title: "Fuel",
          tokenName: "Fuel Token",
          seedPrice: 0.02,
          isTradable: true,
          fontColor: "#32CD32",
          buttonColor: "#32CD32",
        },
        almanak: {
          title: "Almanak",
          tokenName: "Almanak Token",
          seedPrice: 0.0435,
          isTradable: false,
          fontColor: "#FFFFFF",
          buttonColor: "#4A5568",
        },
        pulse: {
          title: "Pulse",
          tokenName: "Pulse Token",
          seedPrice: "Coming Soon",
          isTradable: false,
          fontColor: "#0000FF",
          buttonColor: "#1E90FF",
        },
        silencio: {
          title: "Silencio",
          tokenName: "Silencio Token",
          seedPrice: "Coming Soon",
          isTradable: false,
          fontColor: "#87CEEB",
          buttonColor: "#4682B4",
        },
        enclave: {
          title: "Enclave",
          tokenName: "Enclave Token",
          seedPrice: "ICO Soon",
          isTradable: false,
          fontColor: "#FFFFFF",
          buttonColor: "#ADD8E6",
        },
        corn: {
          title: "Corn",
          tokenName: "Corn Token",
          seedPrice: "ICO Soon",
          isTradable: false,
          fontColor: "#FFA500",
          buttonColor: "#FF8C00",
        }
      };

      // Overview
      let currentSale = 'overview';

      // Cache
      const CACHE_TTL = 120000; // 2 minutes in milliseconds
      let cachedFuelData = null;
      let cachedFuelTimestamp = null;

      // Switch pages
      window.switchSale = function(sale) {
        currentSale = sale;

        if (sale === 'overview') {
          document.querySelectorAll(".sale-tab").forEach((tab) => tab.classList.remove("active-tab"));
          document.querySelector(`[onclick="switchSale('overview')"]`).classList.add("active-tab");

          // Show overview
          document.getElementById("mainSaleContainer").classList.add("hidden");
          document.getElementById("overviewSection").classList.remove("hidden");

          showOverview();
          return;
        } else {
          // Show main sale
          document.getElementById("overviewSection").classList.add("hidden");
          document.getElementById("mainSaleContainer").classList.remove("hidden");
        }

        // Normal token logic
        const saleData = sales[sale];
        if (!saleData) return;

        // Highlight correct tab
        document.querySelectorAll(".sale-tab").forEach((tab) => tab.classList.remove("active-tab"));
        document.querySelector(`[onclick="switchSale('${sale}')"]`).classList.add("active-tab");

        // Update headings
        document.getElementById("saleTitle").textContent = saleData.title;
        document.getElementById("tokenName").textContent = saleData.tokenName;

        // Display seed price
        const seedPriceEl = document.getElementById("seedPrice");
        if (typeof saleData.seedPrice === "string") {
          seedPriceEl.textContent = saleData.seedPrice;
        } else {
          seedPriceEl.textContent = `$${saleData.seedPrice.toFixed(4)}`;
        }

        // Enable or disable the Calculate button
        const calculateButton = document.getElementById("calculateButton");
        if (!saleData.isTradable) {
          calculateButton.disabled = true;
          calculateButton.classList.add("disabled-button");
        } else {
          calculateButton.disabled = false;
          calculateButton.classList.remove("disabled-button");
        }

        document.getElementById("saleTitle").style.color = saleData.fontColor;
        calculateButton.style.backgroundColor = saleData.buttonColor;

        // Reset results
        document.getElementById("results").classList.add("hidden");
        document.getElementById("investment").value = "";
      }

      // ROI calculation
      window.calculateROI = async function(event) {
        event.preventDefault();

        const investmentInput = document.getElementById("investment");
        const investment = parseFloat(investmentInput.value);
        const saleData = sales[currentSale];

        if (isNaN(investment) || investment <= 0) {
          alert("Please enter a valid investment amount.");
          investmentInput.focus();
          return;
        }

        // If not tradable, show "Not Available"
        if (!saleData.isTradable) {
          displayResults({
            initial_investment: investment,
            current_price: null,
            roi_value: null,
            status: "Not Available"
          }, saleData);
          return;
        }

        try {
          const response = await fetch("/calculate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ investment, round_price: saleData.seedPrice }),
          });

          if (!response.ok) {
            throw new Error(`Server responded with status ${response.status}`);
          }

          const data = await response.json();
          if (data.error) {
            alert(data.error);
          } else {
            displayResults(data, saleData);
          }
        } catch (error) {
          console.error("Error:", error);
          alert("An error occurred while calculating ROI.");
        }
      }

      // Display Results
      function displayResults(data, saleData) {
        const results = document.getElementById("results");
        results.classList.remove("hidden");

        if (data.status === "Not Available") {
          results.innerHTML = `
            <p class="text-lg text-gray-400">
              Current Token Price: <span class="text-white">Not Available</span>
            </p>
            <p class="text-lg text-gray-400">
              Current Value: <span class="text-white">Not Applicable</span>
            </p>
          `;
          return;
        }

        results.innerHTML = `
          <p class="text-lg text-gray-400">
            Initial Investment: <span class="text-white">$${data.initial_investment.toFixed(2)}</span>
          </p>
          <p class="text-lg text-gray-400">
            Current Token Price: <span class="text-white">$${data.current_price.toFixed(4)}</span>
          </p>
          <p class="text-2xl font-bold mt-4" style="color:${saleData.fontColor}">
            Current Value: $${data.roi_value.toFixed(2)}
          </p>
        `;
      }

      // Overview
      function showOverview() {
        const overviewList = document.getElementById("overviewList");
        overviewList.innerHTML = '';

        // Fetch/Append Fuel FIRST
        fetchFuelThen(() => {
          const otherTokens = ['almanak', 'pulse', 'silencio', 'enclave', 'corn'];
          otherTokens.forEach((tokenKey) => {
            const tokenData = sales[tokenKey];
            if (!tokenData) return;
            addOverviewItem(tokenData.title, 'Coming Soon', 'text-blue-400');
          });
        });
      }

      // Fetches Fuel data, uses cache
      function fetchFuelThen(onDone) {
        const fuelData = sales['fuel'];
        if (!fuelData.isTradable) {
          addOverviewItem('Fuel', 'Not Available', 'text-gray-400');
          if (typeof onDone === 'function') onDone();
          return;
        }

        // Check cache validity
        if (
          cachedFuelData &&
          cachedFuelTimestamp &&
          Date.now() - cachedFuelTimestamp < CACHE_TTL
        ) {
          console.log("Using cached Fuel data");
          displayFuelROI(cachedFuelData);
          if (typeof onDone === 'function') onDone();
        } else {
          console.log("Fetching new Fuel data");
          fetch("/calculate", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ investment: 100, round_price: fuelData.seedPrice }),
          })
          .then((res) => {
            if (!res.ok) {
              throw new Error(`Server responded with status ${res.status}`);
            }
            return res.json();
          })
          .then((data) => {
            if (!data.error) {
              cachedFuelData = data;
              cachedFuelTimestamp = Date.now();
              displayFuelROI(data);
            } else {
              addOverviewItem('Fuel', 'Error', 'text-red-500');
            }
            if (typeof onDone === 'function') onDone();
          })
          .catch(() => {
            addOverviewItem('Fuel', 'Error', 'text-red-500');
            if (typeof onDone === 'function') onDone();
          });
        }
      }

      // Show the ROI% 
      function displayFuelROI(data) {
        const fuelData = sales['fuel'];
        const pctGain = ((data.current_price - fuelData.seedPrice) / fuelData.seedPrice) * 100;
        let roiClass = 'text-green-400';
        if (pctGain < 0) roiClass = 'text-red-500';
        addOverviewItem('Fuel', `${pctGain.toFixed(2)}%`, roiClass);
      }

      // Add Overview Item
      function addOverviewItem(tokenName, roiText, colorClass) {
        const overviewList = document.getElementById("overviewList");
        const row = document.createElement('div');
        row.className = "flex justify-between items-center px-4 py-3 bg-gray-800 bg-opacity-75 rounded transition hover:bg-gray-700";

        const nameEl = document.createElement('span');
        nameEl.className = "font-semibold";
        nameEl.textContent = tokenName;

        const roiEl = document.createElement('span');
        roiEl.className = colorClass;
        roiEl.textContent = roiText;

        row.appendChild(nameEl);
        row.appendChild(roiEl);
        overviewList.appendChild(row);
      }

      // Initial Setup
      switchSale(currentSale);

      // Connect Wallet Functionality
      window.connectWallet = async function() {
        if (!window.ethereum) {
          alert("MetaMask is not installed. Please install it to use this feature.");
          return;
        }

        try {
          // Request account access if needed
          await window.ethereum.request({ method: 'eth_requestAccounts' });

          const provider = new ethers.Web3Provider(window.ethereum);
          const signer = provider.getSigner();
          const address = await signer.getAddress();
          alert(`Connected wallet: ${address}`);
          // You can update the UI to reflect the connected state here
        } catch (error) {
          console.error(error);
          alert("Failed to connect wallet.");
        }
      }
    });
  </script>
</body>
</html>
